# .github/workflows/repo-file-sync.yaml
name: Repo File Sync

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 3 * * MON-FRI' # Run workflow at 12:00 JST every MON-FRI
permissions:
  contents: write
jobs:
  sync:
    env:
      SETTINGS: |
        {
          "kagankan/sync-test-b": [
            "README.md",
          ]
        }
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@v1
        with:
          app_id: ${{ secrets.REPO_FILE_SYNC_APP_ID }}
          private_key: ${{ secrets.REPO_FILE_SYNC_PRIVATE_KEY }}

      - name: Setup
        run: |
          git config user.name "GitHub App Bot"
          git config user.email "<email@domain.com>"
          git checkout -b new-branch-${{ github.run_id }}

      # - name: Clone Repository B and get recent merges
      #   run: |
      #     git clone https://x-access-token:${{ steps.generate_token.outputs.token }}@github.com/kagankan/sync-test-b.git
      #     # cd sync-test-b
      #     # git log --since="24 hours ago" --merges --pretty=format:"%H"
      #     tree
      #     cp sync-test-b/README.md README.md
      #     rm sync-test-b -rf
      #     tree
      #   id: log
      - name: Clone and Sync Repositories
        run: |
          SETTINGS_JSON=$SETTINGS
          REPOS=$(echo "$SETTINGS_JSON" | jq -r 'keys[]')
          for REPO in $REPOS; do
            # Clone the repository
            echo "Cloning $REPO"
            git clone https://x-access-token:${{ steps.generate_token.outputs.token }}@github.com/$REPO.git $REPO

            # Copy the specified files
            FILES=$(echo "$SETTINGS_JSON" | jq -r ".[\"$REPO\"][]")
            for FILE in $FILES; do
              echo "Copying $FILE from $REPO"
              cp "$REPO/$FILE" .
            done

            # Clean up the cloned repository directory
            rm -rf $REPO
          done
          tree
      # - name: Sync file from source repository
      #   run: |
      #     curl -H "Authorization: token ${{ steps.generate_token.outputs.token }}" \
      #     https://api.github.com/repos/kagankan/sync-test-b/contents/README.md > README.md

      - name: Commit changes
        run: |
          git add .
          git commit -m "Update file from source repository" || echo "No changes to commit"
          git push origin new-branch-${{ github.run_id }}
      # - name: Push changes to the new branch
      #   run: |

      - name: Create Pull Request
        uses: repo-sync/pull-request@v2
        with:
          github_token: ${{ steps.generate_token.outputs.token }}
          destination_branch: "main"
          source_branch: new-branch-${{ github.run_id }}
          pr_title: "Update from source repository"
          pr_body: "Automated PR to update the specified file."
