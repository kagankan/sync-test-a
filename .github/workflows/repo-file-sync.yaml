# .github/workflows/repo-file-sync.yaml
name: Repo File Sync

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 3 * * MON-FRI" # Run workflow at 12:00 JST every MON-FRI

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      # ワークフローの書き換えにはworkflows権限が必要
      SETTINGS: |
        [
          {
            "owner": "kagankan",
            "repo": "sync-test-b",
            "paths": [
              "README.md",
              ".eslintrc",
              "test/*.md",
              ".github/workflows/test.yaml",
              ".github/workflows/test.yml"
            ]
          },
          {
            "owner": "kagankan",
            "repo": "sync-test-c",
            "paths": [
              "README.md"
            ]
          }
        ]
    steps:
      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@v1
        with:
          app_id: ${{ secrets.REPO_FILE_SYNC_APP_ID }}
          private_key: ${{ secrets.REPO_FILE_SYNC_PRIVATE_KEY }}
      - uses: actions/checkout@v4
        with:
          # ここに権限を与えないと、workflowsの書き換えができない
          token: ${{ steps.generate_token.outputs.token }}
      - name: Get Previous Run Status
        id: get_previous_status
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate_token.outputs.token }}
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "repo-file-sync.yaml",
              per_page: 2,
            });
            console.log(runs)
            // return runs.workflow_runs[1].run_started_at;
            // デバッグのため固定値
            // return '2024-04-21T11:50:03Z';
            return ''; // 初回の場合は空文字を返す
        #env:
        #  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: ファイル反映
        env:
          # ghコマンドを使うために必要
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          git config user.name "file-sync [bot]"
          git config user.email "<email@example.com>"

          #  前回の同期時刻を取得
          PREVIOUS_RUN="${{ steps.get_previous_status.outputs.result }}"
          echo "PREVIOUS_RUN: $PREVIOUS_RUN"
          # PREVIOUS_RUNがない場合は初回
          [ -z "$PREVIOUS_RUN" ] && INITIAL=true || INITIAL=false

          workspace_dir=$(pwd)

          # SETTINGSをループ
          settings=$(echo "$SETTINGS" | jq -c '.[]')
          for setting in $settings; do
            owner=$(echo "$setting" | jq -r '.owner')
            repo=$(echo "$setting" | jq -r '.repo')
            paths=$(echo "$setting" | jq -r '.paths[]' | sed 's/\n/ /g')
            FILE_SYNC_BRANCH_TMP="file-sync/$repo/tmp"
            FILE_SYNC_BRANCH_NEW="file-sync/$repo/${{ github.run_id }}"

            echo "========================================"
            echo "$owner/$repo の反映"
            echo "========================================"

            # クローン
            REPO_FULL="$owner/$repo"
            TMP_DIR="tmp"
            cd $workspace_dir
            # 直近20件以内にはあるだろう、という決め打ち
            git clone --filter=blob:none --no-checkout --sparse --depth 20 https://x-access-token:${{ steps.generate_token.outputs.token }}@github.com/$REPO_FULL.git $TMP_DIR
            
            cd $TMP_DIR

            # コミット履歴からマージされたプルリクエストを取得
            # mergesがないと関係ないコミットも拾ってしまった
            MERGE_COMMITS=$(git log --sparse --merges --first-parent --since "$PREVIOUS_RUN" --oneline --pretty=format:'%s' -- $paths)
            
            # MERGE_COMMITSが空の場合は何もしない
            if [ -z "$MERGE_COMMITS" ] && [ $INITIAL = false ]; then
              echo "反映する変更がありません"
              continue
            fi

            # sparse-checkoutを設定
            git config core.sparseCheckout true
            git sparse-checkout set --no-cone $paths
            git checkout -b $FILE_SYNC_BRANCH_TMP origin/main  

            # 前回時点のファイルを反映
            COMMIT=$(git rev-list -1 --before="${{ steps.get_previous_status.outputs.result }}" main)
            echo "COMMIT: $COMMIT"
            git -c advice.detachedHead=false checkout $COMMIT
            cd $workspace_dir
            rm -rf $paths # 削除ファイルを反映するために一旦削除
            rsync $TMP_DIR/ . -r --exclude '.git/'

            # コミット作成
            git add . ":!$TMP_DIR"
            git commit -m "$repo の前回時点を反映" || echo "No changes to commit"

            # 追加分のファイル同期
            cd $TMP_DIR
            git checkout origin/main
            cd $workspace_dir
            rm -rf $paths # 削除ファイルを反映するために一旦削除
            rsync $TMP_DIR/ . -r --exclude '.git/'

            # コミット作成
            git add . ":!$TMP_DIR"
            git commit -m "$repo の変更を反映" || echo "No changes to commit"

            COMMIT_HASH=$(git rev-parse HEAD)
            git checkout -b $FILE_SYNC_BRANCH_NEW origin/main  
            rm -rf $TMP_DIR

            CONFLICT=false
            # コンフリクトしたときと、何も差分がないときにエラーになる
            git cherry-pick $COMMIT_HASH || {
              GIT_STATUS=$(git status -s)
              [ -z "$GIT_STATUS" ] && {
                echo "差分がありません"
                git cherry-pick --skip
                continue
              }

              CONFLICT=true
              echo "コンフリクトしました"
              git checkout --theirs .
              git add . ":!$TMP_DIR"
              git cherry-pick --continue
            }
            git push origin $FILE_SYNC_BRANCH_NEW

            # スラッシュが入るため、デリミタを変える
            MERGED_PULLS=$(echo $MERGE_COMMITS | grep -o '#[0-9]\+' | sed "s|^|$REPO_FULL|" || echo '初回反映です')

            # プルリクエストを作成
            echo "Creating pull request"
            gh pr create \
            -B main -H $FILE_SYNC_BRANCH_NEW \
            --reviewer kagankan \
            --title "$repo 取り込み $($CONFLICT && echo '（コンフリクト）' || echo '')" \
            --body "$($CONFLICT && echo "反映中にコンフリクトが発生しました。
            
          - 上書きする場合：このままマージしてください。
          - 手動で修正する場合： \`git cherry-pick $COMMIT_HASH\` を実行して修正の上で別途PRを作成してください。
          - 反映する必要がない場合：クローズしてください。" || echo '自動生成の取り込みです。マージするかクローズしてください。')

          ## 関連PR
          $MERGED_PULLS"

          done
